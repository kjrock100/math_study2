# 7.4 일반화된 포함-배제 원리 (PIE for any Number of Events)

## 1. 개요 (Overview)

이 장에서는 2개 또는 3개의 집합에 적용했던 포함-배제 원리를 임의의 개수 $n$개의 집합으로 확장합니다. 공식이 복잡해 보일 수 있지만, **"홀수 개는 더하고, 짝수 개는 뺀다"**는 단순한 규칙이 반복됩니다.

## 2. 일반화된 공식 (Generalized Formula)

$n$개의 집합 $A_1, A_2, \dots, A_n$에 대하여 합집합의 크기는 다음과 같습니다.

$$
\left|\bigcup_{i=1}^n A_i\right| = \sum \left|A_i\right| - \sum \left|A_i \cap A_j\right| + \sum \left|A_i \cap A_j \cap A_k\right| - \dots + (-1)^{n-1} \left|A_1 \cap \dots \cap A_n\right|
$$

### 패턴 분석

1.  **싱글 ($k=1$):** 각 집합의 크기를 모두 **더합니다 (+)**.
2.  **페어 ($k=2$):** 두 집합 간의 교집합 크기를 모두 **뺍니다 (-)**.
3.  **트리플 ($k=3$):** 세 집합 간의 교집합 크기를 모두 **더합니다 (+)**.
4.  **...**
5.  **$n$개 ($k=n$):** $n$이 홀수면 더하고, 짝수면 뺍니다.

## 3. 주요 응용: 교란 순열 (Derangements)

일반화된 PIE의 가장 유명한 응용 사례는 **교란 순열(Derangement)** 또는 **완전 순열**입니다.

- **정의:** $n$개의 원소를 나열할 때, 어떤 원소도 원래의 위치에 있지 않은 순열의 수. (예: 모자 바꿔 쓰기 문제)
- **기호:** $D_n$ 또는 $!n$ (Subfactorial)
- **공식 유도 (PIE 적용):**
  전체 순열 $n!$에서 적어도 하나가 자기 자리에 있는 경우를 뺍니다.
  $$ D_n = n! \left( 1 - \frac{1}{1!} + \frac{1}{2!} - \frac{1}{3!} + \dots + \frac{(-1)^n}{n!} \right) $$

## 4. 예제 (Examples)

### 예제 1: 4개의 집합

4개의 집합 $A, B, C, D$의 합집합 크기를 구할 때, 마지막 항(4개 모두의 교집합)의 부호는?

- $n=4$ (짝수)이므로 **뺍니다 (-)**.

### 예제 2: 편지 봉투 문제 (Derangement)

편지 4통을 봉투 4개에 무작위로 넣을 때, 모든 편지가 잘못된 봉투에 들어갈 경우의 수는? ($D_4$)
$$ D_4 = 4! \left( \frac{1}{0!} - \frac{1}{1!} + \frac{1}{2!} - \frac{1}{3!} + \frac{1}{4!} \right) $$
$$ = 24 \left( 1 - 1 + \frac{1}{2} - \frac{1}{6} + \frac{1}{24} \right) $$
$$ = 24 \left( \frac{12}{24} - \frac{4}{24} + \frac{1}{24} \right) = 12 - 4 + 1 = 9 $$

## 5. 코드 구현 (Code Implementation)

Python의 `itertools`를 사용하여 일반화된 PIE를 구현하고, 교란 순열을 계산해 봅니다.

### 5.1 일반화된 PIE 구현 (집합 사용)

```python
from itertools import combinations

def generalized_pie(sets):
    """
    sets: 집합(set)들의 리스트 [A, B, C, ...]
    반환값: 합집합의 크기
    """
    n = len(sets)
    union_size = 0

    # k는 1부터 n까지 (선택할 집합의 개수)
    for k in range(1, n + 1):
        term_sum = 0
        # k개의 집합을 선택하는 모든 조합
        for subset in combinations(sets, k):
            # 선택된 집합들의 교집합 구하기
            intersection = set.intersection(*subset)
            term_sum += len(intersection)

        # 홀수는 더하고, 짝수는 뺀다
        if k % 2 == 1:
            union_size += term_sum
        else:
            union_size -= term_sum

    return union_size

# 검증: 1~10 중 2, 3, 5의 배수 (3개 집합)
universe = set(range(1, 11))
A = {x for x in universe if x % 2 == 0}
B = {x for x in universe if x % 3 == 0}
C = {x for x in universe if x % 5 == 0}

print(f"PIE 계산 결과: {generalized_pie([A, B, C])}") # Expected: len({2,3,4,5,6,8,9,10}) = 8
```

## 6. 요약 (Summary)

- **규칙:** 교집합 개수가 홀수면 $+$, 짝수면 $-$.
- **교란 순열:** $D_n \approx \frac{n!}{e}$. (자연상수 $e$와 관련됨)
- $n$이 커질수록 항의 개수가 $2^n-1$개로 급격히 늘어나므로, 손으로 계산할 때는 대칭성을 이용하거나 $n=3, 4$ 정도까지만 다룹니다.
