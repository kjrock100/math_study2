# 3.8.3 Counting Derangements 분석

이 문서는 **3.8.3 Counting Derangements** 섹션의 내용을 분석하고 설명합니다. 이 섹션은 포함-배제의 원리(PIE)의 가장 유명하고 고전적인 응용 중 하나인 **교란 순열(Derangements)**의 개수를 세는 방법을 다룹니다.

## 1. 섹션 개요 (Overview)

순열 중에서 모든 원소가 자기 자신의 원래 위치에 있지 않은 순열을 **교란 순열(Derangement)**이라고 합니다.
> "파티에 온 $n$명의 손님이 모자를 맡겼다가 나갈 때 무작위로 모자를 집어 들었다. 아무도 자신의 모자를 쓰지 않을 확률은 얼마인가?"

이 유명한 **모자 문제(Hat Check Problem)**가 바로 교란 순열 문제입니다.

## 2. 고정점 (Fixed Points)

이 문제를 해결하기 위해 먼저 **고정점(Fixed Point)**의 개념을 이해해야 합니다.

* 순열 $\sigma$에 대해 $\sigma(i) = i$인 경우, $i$를 고정점이라고 합니다.
* 교란 순열은 **고정점이 하나도 없는 순열**입니다.

## 3. PIE를 이용한 유도 (Derivation using PIE)

우리는 "고정점이 없는 순열"을 직접 세는 대신, 전체 순열에서 "적어도 하나의 고정점이 있는 순열"을 빼는 방식을 사용합니다.

1. **전체 집합 ($S$):** $n$개의 원소로 만들 수 있는 모든 순열. $|S| = n!$.
2. **조건 ($A_i$):** $i$번째 원소가 제자리에 있는 경우 (즉, $i$가 고정점인 경우).
3. **목표:** $|S| - |A_1 \cup A_2 \cup \dots \cup A_n|$을 구하는 것.

### 3.1 교집합의 크기 계산

* $|A_i|$: $i$를 고정하고 나머지 $n-1$개를 나열하는 경우 $\rightarrow (n-1)!$.
  * 이런 집합이 $n$개 있으므로 $\binom{n}{1} (n-1)!$.
* $|A_i \cap A_j|$: $i$와 $j$를 고정하고 나머지 $n-2$개를 나열하는 경우 $\rightarrow (n-2)!$.
  * 이런 쌍이 $\binom{n}{2}$개 있으므로 $\binom{n}{2} (n-2)!$.
* 일반화: $k$개의 원소를 고정하는 경우의 수 합은 $\binom{n}{k} (n-k)! = \frac{n!}{k!(n-k)!} (n-k)! = \frac{n!}{k!}$.

## 4. 교란 순열 공식 (The Formula)

PIE 공식에 대입하면 다음과 같습니다.

$$
\begin{aligned}
D_n &= n! - \binom{n}{1}(n-1)! + \binom{n}{2}(n-2)! - \dots + (-1)^n \binom{n}{n} 0! \\
&= n! - \frac{n!}{1!} + \frac{n!}{2!} - \frac{n!}{3!} + \dots + (-1)^n \frac{n!}{n!} \\
&= n! \left( 1 - \frac{1}{1!} + \frac{1}{2!} - \frac{1}{3!} + \dots + \frac{(-1)^n}{n!} \right)
\end{aligned}
$$

* **기호:** $D_n$ 또는 $!n$ (Subfactorial).

## 5. 확률과 근사 (Probability and Approximation)

$n$이 커질수록 괄호 안의 급수는 $e^{-1} = 1/e$의 테일러 급수 전개와 같아집니다.

$$ \lim_{n \to \infty} \frac{D_n}{n!} = \frac{1}{e} \approx 0.3678 $$

즉, 사람이 아무리 많아져도, 아무도 자신의 모자를 돌려받지 못할 확률은 약 36.8%로 수렴합니다. 이는 직관적으로 매우 놀라운 결과입니다.

## 6. 요약

**3.8.3 Counting Derangements**는 PIE가 어떻게 복잡한 제약 조건(모든 원소가 제자리에 있으면 안 됨)을 가진 순열 문제를 우아한 급수 형태로 풀어내는지를 보여줍니다.

* **핵심 아이디어:** 고정점이 있는 경우를 체계적으로 제거한다.
* **결과:** $D_n \approx n!/e$.
