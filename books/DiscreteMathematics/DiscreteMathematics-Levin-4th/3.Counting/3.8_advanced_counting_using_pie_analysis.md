# 3.8 Advanced Counting Using PIE 분석

이 문서는 **3.8 Advanced Counting Using PIE** 섹션의 내용을 분석하고 설명합니다. 이 섹션은 포함-배제의 원리(Principle of Inclusion-Exclusion, PIE)를 단순한 집합의 크기 계산을 넘어, 더 복잡하고 구조적인 카운팅 문제에 적용하는 고급 기법을 다룹니다.

## 1. 섹션 개요 (Overview)

기본적인 카운팅 도구(순열, 조합, 중복 조합)만으로는 해결하기 어려운 문제들이 있습니다. 예를 들어, "상한선이 있는 방정식의 해"를 구하거나, "아무도 자신의 모자를 돌려받지 못하는 경우"를 세는 문제입니다. 이 섹션에서는 이러한 문제들이 **"조건을 위반하는 경우를 제외한다"**는 PIE의 핵심 아이디어를 통해 어떻게 체계적으로 해결되는지 학습합니다.

## 2. 멀티셋을 위한 PIE (PIE for Multisets)

### 2.1 상한 제약 조건 (Upper Bound Constraints)

* **기존 문제:** $x_1 + x_2 + x_3 = 10$ ($x_i \ge 0$)의 해는 중복 조합 $\binom{3+10-1}{10}$으로 쉽게 구할 수 있습니다.
* **새로운 문제:** 만약 $x_1 \le 4$와 같은 **상한 제약**이 추가된다면?
* **해결 전략:**
    1. **전체 경우:** 제약 조건이 없다고 가정하고 계산합니다.
    2. **위반 경우 제외:** $x_1 \ge 5$인 경우(조건 위반)를 전체에서 뺍니다. $x_1$에 미리 5를 주고 시작하는 방식으로 모델링하여 계산할 수 있습니다.
    3. 여러 변수에 제약이 있다면 PIE를 적용하여 중복 제외된 부분을 조정합니다.

## 3. 교란 순열 (Counting Derangements)

### 3.1 정의

* **교란 순열(Derangement):** 모든 원소가 자기 자신의 원래 위치에 있지 않은 순열입니다.
* **기호:** $D_n$ 또는 $!n$ (Subfactorial).
* **모자 문제 (The Hat Check Problem):** $n$명의 사람이 모자를 맡겼다가 무작위로 돌려받을 때, **아무도** 자신의 모자를 받지 못하는 경우의 수는?

### 3.2 공식 유도

전체 순열($n!$)에서 적어도 한 명이 자신의 모자를 받는 경우를 뺍니다.
$$ D_n = n! \sum_{k=0}^n \frac{(-1)^k}{k!} = n! \left( 1 - \frac{1}{1!} + \frac{1}{2!} - \frac{1}{3!} + \dots + \frac{(-1)^n}{n!} \right) $$

* **흥미로운 사실:** $n$이 커질수록, 무작위로 모자를 나눠줄 때 교란 순열이 될 확률($D_n/n!$)은 $1/e \approx 0.368$에 수렴합니다.

## 4. 함수의 개수 세기 (Counting Functions)

### 4.1 전사 함수 (Surjective Functions)

* **문제:** 정의역의 크기가 $m$, 공역의 크기가 $n$일 때, 공역의 모든 원소가 적어도 한 번 선택받는(Onto) 함수의 개수는?
* **PIE 적용:**
  * 조건: 공역의 원소 $y_1, y_2, \dots, y_n$이 모두 치역에 포함되어야 함.
  * 여사건: 치역에서 $y_i$가 제외되는 경우.
* **공식:**
    $$ \text{Surjections} = \sum_{k=0}^n (-1)^k \binom{n}{k} (n-k)^m $$
  * $(n-k)^m$: 공역에서 $k$개의 원소를 제외하고 함수를 만드는 경우의 수.

## 5. 요약

**3.8 Advanced Counting Using PIE**는 PIE가 단순한 벤 다이어그램 계산을 넘어, 제약 조건이 까다로운 조합론적 구조를 분석하는 강력한 일반화된 도구임을 보여줍니다.

* **제약이 있는 방정식** $\rightarrow$ 위반 사례를 뺀다.
* **고정점이 없는 순열** $\rightarrow$ 고정점이 있는 경우를 뺀다.
* **치역이 꽉 찬 함수** $\rightarrow$ 치역이 비는 경우를 뺀다.

이 모든 문제는 **"전체에서 성질을 만족하지 않는 것들을 체계적으로 제외한다"**는 동일한 논리로 해결됩니다.
